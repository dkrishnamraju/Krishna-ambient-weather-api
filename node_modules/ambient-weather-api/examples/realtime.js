require('dotenv').config()
const AmbientWeatherApi = require('../lib/index')
const moment = require('moment-timezone');
const https = require('https');
const cron = require('node-cron');
// helper function
function getName (device) {
  return device.info.name
}

const apiKey = process.env.AMBIENT_WEATHER_API_KEY || 'baf21a6a36ef416380bb769b53516b0feca8ff214968400780b60401d620f919'
const api = new AmbientWeatherApi({
  apiKey,
  applicationKey: process.env.AMBIENT_WEATHER_APPLICATION_KEY || 'f96c7ccf09374a52a4e4e016985f7ed0c7ea1be8d4a2412e933705b10cf1778a'
})

function convertToIST(date) {
  const format = 'YYYY-MM-DD hh:mm:ss A';
  const utcDate = moment.utc(date);
  const istDate = utcDate.tz('Asia/Kolkata').format(format);
  return istDate;
}

let T30AeratorsONoptions = {
  hostname: 'maker.ifttt.com',
  port: 443,
  path: '/trigger/TurnOnT30Aerators/with/key/kHUAajXgmiiGjtFB7IOdg2iU92Q1xjBs2sxz4vt4qut',
  method: 'POST'
};

let T30AeratorsOFFoptions = {
  hostname: 'maker.ifttt.com',
  port: 443,
  path: '/trigger/TurnOffT30Aerators/with/key/kHUAajXgmiiGjtFB7IOdg2iU92Q1xjBs2sxz4vt4qut',
  method: 'POST'
};

function fahrenheitToCelsius(fahrenheit) {
  var celsius = (fahrenheit - 32) * 5 / 9;
  return celsius.toFixed(1);
}

function convertMphToKmph(mph) {
  const kmph = mph * 1.60934;
  return kmph.toFixed(1);
}

let RecentWeatherData = [];
let AvgWindSpeedKmph = 0;
let RecentWindSpeed = 0;
let TurnOnAeratorsFlag = 0;
let AWSDeviceConnected = 0;
let AWSDeviceSubscribed = 0;
let AeratorsActiveFlag = 0;

api.on('connect', () => {
  console.log('Connected to Ambient Weather Realtime API!');
  AWSDeviceConnected = 1;
  //DataMissingMinutes = 2; 
}
)

api.on('subscribed', data => {
  AWSDeviceSubscribed = 1;
  console.log('Subscribed to ' + data.devices.length + ' device(s): ');
  console.log(data.devices.map(getName).join(', '));
  /* This one is to give 3 minutes of time before trying to connect again.
     Because after 5 Data missing minutes, it will again trigger connect. */
  //DataMissingMinutes = 2;  
})


api.on('data', data => {

  RecentWindSpeed  = convertMphToKmph(data.windspeedmph);

  if(RecentWeatherData.length < 5)
  {
    RecentWeatherData.push(data);
  }
  else
  {
    RecentWeatherData.shift();
    RecentWeatherData.push(data);
  }

  // Calculate average (replace 'windspeedmph' with the actual property you're interested in)

let sum = RecentWeatherData.reduce((a, b) => a + b.windspeedmph, 0);
let avg = sum / RecentWeatherData.length;
AvgWindSpeedKmph = convertMphToKmph(avg);
newWeatherData = 1;
})

api.on('error', error => {
  console.error(`An error occurred: ${error.message}`);
});

let newWeatherData = 0;
let DataMissingMinutes = 0;
//const now = moment();


function processData()
{
  const now = moment(); 

  
  /* if new data received between 10 PM to 7 AM*/
  if((now.hour() >= 22) || (now.hour() < 7))  
  {
    if(AeratorsActiveFlag == 0)
    {
      api.connect();
      api.subscribe(apiKey);
      console.log('Starting Aerators Active Time at ' + now.hour()+ ':' + now.minute())
      AeratorsActiveFlag = 1;
    }
    if(newWeatherData == 1)
    {
      if(now.minute() % 3 === 0 )
      {
        if((AvgWindSpeedKmph < 0.3)/*  & (TurnOnAeratorsFlag == 0)*/)
        {
          TurnOnAeratorsFlag = 1;
        }

        if((AvgWindSpeedKmph > 1.0)/* & (TurnOnAeratorsFlag == 1)*/)
        {
          TurnOnAeratorsFlag = 0;
        }

        if(TurnOnAeratorsFlag == 0)
        {
          let req = https.request(T30AeratorsOFFoptions).end();
        }
        else
        {
          let req = https.request(T30AeratorsONoptions).end();
        }



      }
    
      //console.log(convertToIST(data.date) + ' - ' + getName(data.device) + ' current outdoor temperature is: ' + fahrenheitToCelsius(data.tempf) + 'Â°C');
      console.log(convertToIST(RecentWeatherData.date) + ' - '  + ' WindSpeed: ' + RecentWindSpeed + ' kmph');
      console.log(convertToIST(RecentWeatherData.date) + ' - '  + ' AvgWindSpeed: ' + AvgWindSpeedKmph + ' kmph and AERATORS = ' + TurnOnAeratorsFlag + '\n');
      //let req = https.request(options).end();
      //console.log(data);
      newWeatherData = 0;
      DataMissingMinutes = 0;
      //AWSDeviceConnected = 1;
    }
    else
    {
      DataMissingMinutes = DataMissingMinutes + 1;
      console.log('Not receiving data from last ' + DataMissingMinutes + ' minutes and AERATORS = ' + TurnOnAeratorsFlag );

      if(DataMissingMinutes == 2 || DataMissingMinutes == 3)
      {
        api.subscribe(apiKey);
      }

      if((DataMissingMinutes >= 6) && (DataMissingMinutes % 3 === 0))
      {
        //AWSDeviceConnected = 0;
        api.connect();
        api.subscribe(apiKey);
      }
    }

//    if(AWSDeviceConnected == 0)
//  {
//    api.connect();
//    api.subscribe(apiKey);
//  }
  //else if((AWSDeviceConnected == 1) && (AWSDeviceSubscribed == 0))
  //{
  //  api.subscribe(apiKey);
  //}
  //else if(DataMissingMinutes >= 5)
  //{
  //  AWSDeviceConnected = 0;
  //  AWSDeviceSubscribed = 0;
  //}

  }
  else 
  {

   if(TurnOnAeratorsFlag == 1)
   {
    let req = https.request(T30AeratorsOFFoptions).end();
    TurnOnAeratorsFlag = 0;   
   }

   if(AeratorsActiveFlag == 1)
   {
     console.log('Ending Aerators Active Time at ' + now.hour()+ ':' + now.minute()+'\nI Have The Best Crop')
     AeratorsActiveFlag = 0;
   }
   
   if( AWSDeviceConnected  == 1)
   {
    api.disconnect();
    AWSDeviceConnected = 0;
   }

   if(AWSDeviceSubscribed == 1)
   {
    api.unsubscribe(apiKey);
    AWSDeviceSubscribed = 0;
   }
   
  }
 
}

// Task to run at the 10th second of every minute
let processDataTask = cron.schedule('1 * * * * *', () => {
  processData();
}, {
  scheduled: true,
  timezone: "Asia/Kolkata"
});

processDataTask.start();
//setInterval(processData, 60000);

