require('dotenv').config()
const AmbientWeatherApi = require('../lib/index')
const moment = require('moment-timezone');
const https = require('https');
// helper function
function getName (device) {
  return device.info.name
}

const apiKey = process.env.AMBIENT_WEATHER_API_KEY || 'baf21a6a36ef416380bb769b53516b0feca8ff214968400780b60401d620f919'
const api = new AmbientWeatherApi({
  apiKey,
  applicationKey: process.env.AMBIENT_WEATHER_APPLICATION_KEY || 'f96c7ccf09374a52a4e4e016985f7ed0c7ea1be8d4a2412e933705b10cf1778a'
})

function convertToIST(date) {
  const format = 'YYYY-MM-DD hh:mm:ss A';
  const utcDate = moment.utc(date);
  const istDate = utcDate.tz('Asia/Kolkata').format(format);
  return istDate;
}

let options = {
  hostname: 'maker.ifttt.com',
  port: 443,
  path: '/trigger/TurnOffT30Aerators/with/key/kHUAajXgmiiGjtFB7IOdg2iU92Q1xjBs2sxz4vt4qut',
  method: 'POST'
};

function fahrenheitToCelsius(fahrenheit) {
  var celsius = (fahrenheit - 32) * 5 / 9;
  return celsius.toFixed(1);
}

function convertMphToKmph(mph) {
  const kmph = mph * 1.60934;
  return kmph.toFixed(1);
}

api.connect()
api.on('connect', () => console.log('Connected to Ambient Weather Realtime API!'))

api.on('subscribed', data => {
  console.log('Subscribed to ' + data.devices.length + ' device(s): ')
  console.log(data.devices.map(getName).join(', '))
})
api.on('data', data => {
  //console.log(convertToIST(data.date) + ' - ' + getName(data.device) + ' current outdoor temperature is: ' + fahrenheitToCelsius(data.tempf) + 'Â°C')
  console.log(convertToIST(data.date) + ' - ' + getName(data.device) + ' WindSpeed: ' + convertMphToKmph(data.windspeedmph) + ' kmph')
  let req = https.request(options).end();
 //console.log(data);
})
api.subscribe(apiKey)
